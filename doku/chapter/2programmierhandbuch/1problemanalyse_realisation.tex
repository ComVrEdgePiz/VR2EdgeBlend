%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Problemanalyse und Realisation}
\label{sec:programmierhandbuch:analyse_realisation}
In diesem Abschnitt werden die wesentlichen Bestandteile des Plug-In beschrieben. Es wird das Ansprechen der Ausgabegeräte und die Generieren der Blending-Maske analysiert, sowie deren Implementierung erklärt.

\subsection{Ansprechen der Ausgabegeräte}
Hinter diesem Punkt verbirgt sich die Beschreibung der verwendeten Methoden um die Bilddaten zu manipulieren und eine ansonsten normale Funktionalität des Betriebssystems zu gewährleisten.

\subsubsection{Analyse}
Die Konfiguration welcher Bereich von welchem Ausgabegerät dargestellt wird, erfolgt über den X-Server, ebenso wie die Auswertung des User-Inputs, das Zeichnen des Mousezeigers, die Verwaltung der Programmfenster und des Arbeitsbereiches.

Compiz übernimmt das Compositing der Ausgabe und ermöglicht somit die Manipulationen der Darstellung. Es werden zwei Arten der Manipulation bereitgestellt:
\begin{enumerate}
\item Normal - Jedes vom X-Server verwaltetes Ausgabegerät wird einzeln abgearbeitet
\item Fullscreen - Alle Ausgabegeräte werden gleichzeitig verarbeitet
\end{enumerate}

Um die benötigten Überlappungen für das Edgblending zu erhalten, muss die Auflösung des Desktops reduziert werden. Hierzu kommen folgende Möglichkeiten in Frage:

\begin{enumerate}
\item Der X-Server bietet eine Möglichkeit an, die vorhandenen Ausgabegeräte mit Überlappungsbereich zu konfigurieren.
\item Mittels des Events X-Server-Events {\it StructureNotifyMask} kann die aktuelle Sturktur des Bildschirm zur Laufzeit geändert werden. 
\item Es wird die orginal Konfiguration der Ausgabegeräte beibehalten, nur der interaktiv nutzbare Bereich des Desktops - die Workarea - wird künstlich um die summierte Größe der benötigten Überlappungsbereiche eingeschränkt. Nun können die einzelnen Breiche des Workspace passend auf die Ausgabegeräte ausgegeben werden.
\end{enumerate}

Eine Realisierung des Edgeblending mittels der ersten aufgezeigten Möglichkeit, ist durch die Verwaltung der Überlappungsbereiche durch den X-Server bedingt, nicht möglich. Ausgabe die in den Schnittbereich zweier horizontal angeordnete Ausganegeräte gezeichnet werden, werden auf beiden ausgegeben. Es ist damit nicht möglich unterschiedliche Verläufe auf die Geräte zu zeichnen. 

Eine Umsetzung mittels der zweiten aufgezeigten Methode ist ebenfalls nicht möglich, da die Verringerung der Desktopauflösung gleichzeitig mit der Verringerrung des Viewports einhergeht. Dies führt zu deaktivierten Bereichen im Viewport, die Veränderungen des Framebufferinhalt nicht mehr aktualisert werden.

Eine Realisation ist damit nur mittels der dritten aufgezeigten Möglichkeit zu erreichen.

\subsubsection{Realisation}
\begin{description}
\item[Workspace-Anpassungen:] Es wird die Größe des Workarea reduziert und Compiz zur Fullscreen-Ausgabe gezwungen, dies erfordert Änderungen im X-Server, als auch an der internen Struktur von Compiz. Diese erfolgen beim Starten des Plugins und werden beim Beenden des Plugins wieder rückgängig gemacht. 
\begin{description}

\item[X-Server:] 
\begin{itemize}
\item Die Konfiguration der aktuellen Worksarea ({\it \_NET\_WORKAREA}), die Desktop-Geometrie ({\it \_NET\_DESKTOP\_GEOMETRY}) sowie der Desktop-Viewport ({\it \_NET\_DESKTOP\_VIEWPORT}) werden in der Höhe und der Breit jeweils um die Ausmaße der Überlappungebereiche reduziert.
\item Das Zeichnen des Mosue-Cursors wird deaktiviert, da dieser erst nach den Manipulationen von Compiz gezeichnet werden würde.
\end{itemize}

\item[Compitz:] 
\begin{itemize}
\item Durch das Setzen der Member {\it wasForcedIndependetOutput} und {\it hasOverlappingOutputs} des {\it CompScreen}-Record wird Compiz gezwungen die Fullscreenfunktion für die Ausgabemanipulation zu verwenden.
\item Die ebenfalls im {\it CompScreen}-Record verwalteten Ausgabegerätegrößen ({\it outputDev}) werden an die neue Workarea angepasst.
\item Die Dock-Bars (z.B. der Taskbar) von Gnome wird an den unteren/rechten Rand der neuen Workarea verschoben.
\end{itemize}

\end{description}

\item[Ausgabemaipulationen:] Hierfür werden drei Schritte benötigt
\begin{enumerate}

\item Die aktuelle Cursortextur wird aus dem X-Server ausgelesen und durch das Plugin an die momentane Cursorposition gezeichnet.

\item Die Verteilung des Workarea-Inhaltes auf die Ausgabegeräte erfolgt mittels kopieren des Framebufferinhaltes. Hierbei wird beim unteren rechten Ausgabegerät begonnen und der ensprechende Ausschitt der Workarea auf den Ausschnitt des zugehörigen Ausgabegerätes kopiert. Die restliche Bereiche werden von rechts nach links und von unten nach oben abgearbeitet.

\item Die erzeuge Blending-Textur wird über den gesamten Viewport gelegt.

\end{enumerate}

\end{description}

Die Abbildung 3.1 veranschaulicht die hier besprochenen Schritte.



\begin{figure}
\centering % zum zentrieren, kannst Du auch weglassen
\includegraphics[width=\linewidth]{gfx/outputerzeugung.pdf}
\caption{Erzeugung des Egeblendings}
\label{fig:gridoutput}
\end{figure}
\newpage

\subsection{Generieren der Blending-Maske}
Nachdem im vorherigen Abschnitt beschrieben wurde, wie die erzeugte Maske mit der eigentlichen Benutzeroberfläche zusammengefügt wird, beschreibt dieser Abschnitt wie die Maske erstellt wird.
Resultierend muss die Maske als Grafik vorliegen, die über jeden Output geblendet werden kann. Daher muss entweder pro Ausgabegerät eine Maske erzeugt werden oder eine die über alle Ausgaben angewendet werden kann. Die Konfiguration lässt hier für den Blending-Verlauf pro Seite eines Screens eine Funktion 2. Grades zu. Dies sind die Restriktionen, die für das Generieren der Maske gelten.

\subsubsection{Analyse}
Die beiden Möglichkeiten zur Generierung der Maske sind über
\begin{enumerate}
  \item absolute Funktionen und Relationen oder
  \item relative Funktionen möglich.
\end{enumerate}

Absolute Funktionen für die obere und untere Kante, sowie Relationen für die linke und rechte Kante des Screens sind unpraktikabel, da nicht davon ausgegangen werden kann, dass es immer eindeutige links-rechts, oben-unten zuordnungen gibt. Zudem ist es für den konfigurierenden Benutzer nicht so einfach die gewünschten Funktionen und Relationen zu erstellen wie in der zweiten Möglichkeit.

Die Funktionen relativ zur jeweiligen Seite zu erstellen, mit der Seite als X-Koordinate und dem linken Ende als Nullpunkt ist wesentlich intuitiver.

Eine zusätzliche unabhängige Möglichkeit kann dadurch gegeben werden, dass ein Bild eingelesen wird welches beliebig durch ein Grafikbearbeitungsprogramm manipuliert werden kann.


\subsubsection{Realisation}
Gewählt wurde der intuitivere Ansatz der relativen Funktionen und die unabhängige Möglichkeit die Maske direkt vorzugeben. So wird jede Seite jedes Screen die jeweilige Funktion aus der Konfiguration entnommen. Die Errechnung des Blending-Wertes geschieht durch vertauschen der Koordinaten, so dass das linke Ende einer Seite den Nullpunkt im Koordinatensystem darstellt. Es lassen sich mit einigen Additionen und Subtraktionen die Funktionen auf die vier Seiten eines Screens abbilden.

Für die Manipulation der Helligkeit muss einzig der Alpha-Wert angepasst werden. Die anderen drei Werte werden nicht angepasst. Bei der Anpassung wird dabei pro Pixel errechnet ob dieser unterhalb einer Funktion liegt und dem entsprechend wird Anteilig zwischen dem Außenrand des Screen und der Funktion der Alpha-Wert gesetzt. An den Ecken müssen diese Werte natürlich verrechnet werden, wenn der betreffende Pixel unterhalb zweier Funktionen liegt.

Wenn $f$ die Blendingfunktion und $p$ der aktuell betrachtete Pixel ist. $a$, $b$ und $c$ $f$ als $f(x) = a*x^2 + b*x + c$ definieren und $p_y < f(p_x)$ ist, dann ist $p_alpha = (f(p_x) - p_y) / f(p_x)$ (natürlich nur für $f(p_x) > 0$).

Da die Bilddaten auf Wunsch direkt abgelegt werden können, sind diese auch für exotischere Projektionsoberflächen manipulierbar. Obwohl mit einer Funktion 2. Grades pro Screen-Kante selbst Edgeblending bei Halbkugeln kein Problem ist.
Wenn die Maske nicht aus der Datei gelesen wird dauert das Starten des Plug-In länger, da sie komplett erstellt werden muss.